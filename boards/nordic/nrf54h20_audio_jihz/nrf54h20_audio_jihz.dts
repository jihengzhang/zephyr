/*
 * Copyright (c) 2024 Nordic Semiconductor ASA
 * SPDX-License-Identifier: Apache-2.0
 */

/dts-v1/;
#include <nordic/nrf54h20_cpuapp.dtsi>
#include "nrf54h20_audio_jihz-pinctrl.dtsi"
#include <zephyr/dt-bindings/sensor/ina230.h>

/ {
    model = "Nordic nRF54H20 Audio JIHZ";
    compatible = "nordic,nrf54h20-audio-jihz";

    chosen {
        zephyr,console = &uart0;
        zephyr,shell-uart = &uart0;
        zephyr,uart-mcumgr = &uart0;
        zephyr,bt-mon-uart = &uart0;
        zephyr,bt-c2h-uart = &uart0;
        zephyr,bt-hci = &bt_hci_ipc0;
        zephyr,sram = &sram0;
        zephyr,flash = &flash0;
        zephyr,code-partition = &slot0_partition;
        zephyr,i2s-dai = &i2s0;
        watchdog0 = &wdt0;
    };

    /* System LED definitions */
    leds {
        compatible = "gpio-leds";
        led0: led_0 {
            gpios = <&gpio0 0 GPIO_ACTIVE_LOW>;
            label = "Green LED 0";
        };
        led1: led_1 {
            gpios = <&gpio0 1 GPIO_ACTIVE_LOW>;
            label = "Red LED 1";
        };
        led2: led_2 {
            gpios = <&gpio0 2 GPIO_ACTIVE_LOW>;
            label = "Blue LED 2";
        };
    };

    /* Push buttons */
    buttons {
        compatible = "gpio-keys";
        button0: button_0 {
            gpios = <&gpio0 3 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;
            label = "Push button 0 (USER)";
        };
        button1: button_1 {
            gpios = <&gpio0 4 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;
            label = "Push button 1 (VOL+)";
        };
        button2: button_2 {
            gpios = <&gpio0 5 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;
            label = "Push button 2 (VOL-)";
        };
    };

    pmic {
        compatible = "nordic,npm1100";
        nordic,iset-gpios = <&gpio0 23 GPIO_ACTIVE_HIGH>;
    };

    board_id: board_id {
        compatible = "voltage-divider";
        io-channels = <&adc 0>;
        output-ohms = <20000>;
        full-ohms = <47000>;
        power-gpios = <&gpio0 24 GPIO_ACTIVE_HIGH>;
    };

    pwmleds {
        compatible = "pwm-leds";
        rgb1_red_pwm_led: pwm_led_0 {
            pwms = <&pwm0 0 PWM_MSEC(20) PWM_POLARITY_NORMAL>;
        };
        rgb1_green_pwm_led: pwm_led_1 {
            pwms = <&pwm0 1 PWM_MSEC(20) PWM_POLARITY_NORMAL>;
        };
        rgb1_blue_pwm_led: pwm_led_2 {
            pwms = <&pwm0 2 PWM_MSEC(20) PWM_POLARITY_NORMAL>;
        };
    };

    aliases {
        pwm-led0 = &rgb1_red_pwm_led;
        pwm-led1 = &rgb1_green_pwm_led;
        pwm-led2 = &rgb1_blue_pwm_led;
        red-pwm-led = &rgb1_red_pwm_led;
        green-pwm-led = &rgb1_green_pwm_led;
        blue-pwm-led = &rgb1_blue_pwm_led;
    };

    /* Audio codec configuration */
    cs47l63: cs47l63 {
        compatible = "cirrus,cs47l63";
        reset-gpios = <&gpio0 18 GPIO_ACTIVE_LOW>;
        irq-gpios = <&gpio0 19 GPIO_ACTIVE_LOW>;
        gpio9-gpios = <&gpio0 20 GPIO_ACTIVE_LOW>;
    };

    /* Audio routing configuration */
    sound {
        compatible = "simple-audio-card";
        simple-audio-card,name = "nRF54H20 Audio Card";
        simple-audio-card,format = "i2s";
        simple-audio-card,widgets =
            "Microphone", "Digital Mic",
            "Headphone", "HP Jack";
        simple-audio-card,routing =
            "HP Jack", "HP_L",
            "HP Jack", "HP_R",
            "ADC", "Digital Mic";
        
        simple-audio-card,cpu {
            sound-dai = <&i2s0>;
        };
        
        simple-audio-card,codec {
            sound-dai = <&audio_codec 0>;
        };
    };

    /* Power domains */
    power-domains {
        compatible = "power-domain-map";
        audio_pd: audio {
            reg = <0>;
            label = "AUDIO";
        };
    };
};

/* Enable UART0 for debug console */
&adc {
    status = "okay";
    #address-cells = <1>;
    #size-cells = <0>;

    channel@0 {
        reg = <0>;
        zephyr,gain = "ADC_GAIN_1_4";
        zephyr,reference = "ADC_REF_VDD_1_4";
        zephyr,acquisition-time = <ADC_ACQ_TIME(ADC_ACQ_TIME_MICROSECONDS, 40)>;
        zephyr,input-positive = <NRF_SAADC_AIN6>;
        zephyr,resolution = <12>;
        zephyr,oversampling = <8>;
    };
};

&gpiote {
    status = "okay";
};

&gpio0 {
    status = "okay";

    codec-interface {
        gpio-hog;
        gpios = <21 GPIO_ACTIVE_HIGH>;
        output-low;
    };
};

&gpio1 {
    status = "okay";
};

&uart0 {
    status = "okay";
    current-speed = <115200>;
    pinctrl-0 = <&uart0_default>;
    pinctrl-1 = <&uart0_sleep>;
    pinctrl-names = "default", "sleep";
};

/* I2S configuration for audio */
&i2s0 {
    compatible = "nordic,nrf-i2s";
    status = "okay";
    pinctrl-0 = <&i2s0_default>;
    pinctrl-1 = <&i2s0_sleep>;
    pinctrl-names = "default", "sleep";
};

/* I2C configuration for audio codec control */
arduino_i2c: &i2c1 {
    compatible = "nordic,nrf-twim";
    status = "okay";
    pinctrl-0 = <&i2c1_default>;
    pinctrl-1 = <&i2c1_sleep>;
    pinctrl-names = "default", "sleep";

    vbat_sensor: ina231@44 {
        compatible = "ti,ina230";
        reg = <0x44>;
        adc-mode = "Bus and shunt voltage continuous";
        vbus-conversion-time-us = <4156>;
        vshunt-conversion-time-us = <4156>;
        avg-count = <1024>;
        current-lsb-microamps = <1>;
        rshunt-micro-ohms = <510000>;
    };

    vdd1_codec_sensor: ina231@45 {
        compatible = "ti,ina230";
        reg = <0x45>;
        adc-mode = "Bus and shunt voltage continuous";
        vbus-conversion-time-us = <4156>;
        vshunt-conversion-time-us = <4156>;
        avg-count = <1024>;
        current-lsb-microamps = <1>;
        rshunt-micro-ohms = <2200000>;
    };

    vdd2_codec_sensor: ina231@41 {
        compatible = "ti,ina230";
        reg = <0x41>;
        adc-mode = "Bus and shunt voltage continuous";
        vbus-conversion-time-us = <4156>;
        vshunt-conversion-time-us = <4156>;
        avg-count = <1024>;
        current-lsb-microamps = <1>;
        rshunt-micro-ohms = <2200000>;
    };
};

/* SPI configuration for external flash */
&spi0 {
    status = "okay";
    pinctrl-0 = <&spi0_default>;
    pinctrl-1 = <&spi0_sleep>;
    pinctrl-names = "default", "sleep";
    cs-gpios = <&gpio0 11 GPIO_ACTIVE_LOW>;

    flash0: flash@0 {
        compatible = "nordic,qspi-nor";
        reg = <0>;
        status = "okay";
        spi-max-frequency = <32000000>;
        power-domain = <&audio_pd>;
        
        partitions {
            compatible = "fixed-partitions";
            #address-cells = <1>;
            #size-cells = <1>;

            boot_partition: partition@0 {
                label = "mcuboot";
                reg = <0x0 0x10000>;
            };
            slot0_partition: partition@10000 {
                label = "image-0";
                reg = <0x10000 0x40000>;
            };
            slot1_partition: partition@50000 {
                label = "image-1";
                reg = <0x50000 0x40000>;
            };
            storage_partition: partition@90000 {
                label = "storage";
                reg = <0x90000 0x6000>;
            };
        };
    };
};

zephyr_udc0: &usbd {
    compatible = "nordic,nrf-usbd";
    status = "okay";

    hs_0: hs_0 {
        compatible = "usb-audio-hs";
        mic-feature-mute;
        mic-channel-l;
        mic-channel-r;

        hp-feature-mute;
        hp-channel-l;
        hp-channel-r;
    };
};

/* Include partition configuration */
#include <nordic/nrf54h20_partition.dtsi>
